<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Swallows.Desktop.ViewModels"
        xmlns:models="using:Swallows.Core.Models"
        x:Class="Swallows.Desktop.Views.SettingsWindow"
        x:DataType="vm:SettingsViewModel"
        x:Name="Root"
        Title="Settings - Swallows"
        Width="600" Height="500"
        Icon="/Assets/swallows.png"
        CanResize="False"
        WindowStartupLocation="CenterOwner">

    <Design.DataContext>
        <vm:SettingsViewModel/>
    </Design.DataContext>

    <Window.Styles>
        <Style Selector="TextBlock.label">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
        </Style>
        <Style Selector="TextBox, ComboBox, NumericUpDown">
            <Setter Property="Margin" Value="0,0,0,15"/>
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="*, Auto" Margin="20">
        <!-- Settings Form -->
        <ScrollViewer Grid.Row="0">
            <StackPanel Spacing="10">
                <TextBlock Text="Crawler Configuration" FontSize="18" FontWeight="Bold" Margin="0,0,0,15"/>

                <!-- User Agent -->
                <TextBlock Text="User Agent" Classes="label"/>
                <ComboBox ItemsSource="{Binding PredefinedUserAgents}"
                          SelectedItem="{Binding UserAgent}"
                          HorizontalAlignment="Stretch"/>

                <!-- Delay -->
                <TextBlock Text="{Binding DelayBetweenRequestsMs, StringFormat='Delay Between Requests: {0}ms'}" Classes="label"/>
                <Slider Minimum="0" Maximum="5000" Value="{Binding DelayBetweenRequestsMs}"
                        TickFrequency="100" IsSnapToTickEnabled="True"/>

                <!-- Proxy -->
                <TextBlock Text="Proxy URL (optional)" Classes="label"/>
                <TextBox Watermark="http://proxy.example.com:8080" Text="{Binding ProxyUrl}"/>

                <!-- Concurrent Requests -->
                <TextBlock Text="Concurrent Requests (parallelism)" Classes="label"/>
                <NumericUpDown Minimum="1" Maximum="10" Value="{Binding ConcurrentRequests}"/>

                <TextBlock Text="Scan Limits" FontSize="18" FontWeight="Bold" Margin="0,15,0,15"/>

                <!-- Max Pages -->
                <TextBlock Text="Max Pages" Classes="label"/>
                <NumericUpDown Minimum="1" Maximum="999999" Value="{Binding MaxPages}"/>

                <!-- Max Depth -->
                <TextBlock Text="Max Depth" Classes="label"/>
                <NumericUpDown Minimum="1" Maximum="999" Value="{Binding MaxDepth}"/>
                
                <!-- Save Images -->
                <CheckBox Content="Save Image Metadata to Database" IsChecked="{Binding SaveImages}" Margin="0,5,0,15" ToolTip.Tip="Store image URLs, titles, and alt text for sitemap export"/>

                <!-- Timeout -->
                <TextBlock Text="Timeout (seconds)" Classes="label"/>
                <NumericUpDown Minimum="5" Maximum="120" Value="{Binding TimeoutSeconds}"/>
                
                <TextBlock Text="JavaScript Rendering (Beta)" FontSize="18" FontWeight="Bold" Margin="0,15,0,15"/>
                
                <CheckBox Content="Enable Headless Browser (Playwright)" IsChecked="{Binding EnableJavaScript}"/>
                
                <StackPanel IsVisible="{Binding EnableJavaScript}" Margin="20,0,0,0">
                    <TextBlock Text="The first time you use this, you must install browsers:" Classes="label" FontSize="11" Foreground="Gray"/>
                    <Button Content="Install Playwright Browsers" Command="{Binding InstallPlaywrightCommand}"/>
                    <TextBlock Text="{Binding SettingsStatus}" Foreground="Red" Margin="0,5,0,5"/>
                    
                    <TextBlock Text="AJAX Timeout (wait for dynamic content)" Classes="label" Margin="0,10,0,5"/>
                    <NumericUpDown Minimum="1" Maximum="60" Value="{Binding AjaxTimeoutSeconds}"/>
                    
                    <CheckBox Content="Load Images (Headless)" IsChecked="{Binding EnableHeadlessImages}" Margin="0,5,0,0"/>
                </StackPanel>
                
                <Separator Margin="0,20"/>
                
                <TextBlock Text="Custom Extraction Rules" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>
                <TextBlock Text="Define XPath or Regex to extract custom data (e.g. Price, SKU)." Classes="label" Foreground="Gray" FontSize="12"/>
                
                <DataGrid ItemsSource="{Binding ExtractionRules}" AutoGenerateColumns="False" Height="200" CanUserResizeColumns="True" BorderThickness="1" BorderBrush="#E2E8F0">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="100"/>
                        <DataGridTemplateColumn Header="Type" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding Types}" SelectedItem="{Binding Type}" HorizontalAlignment="Stretch" Margin="5"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Pattern" Binding="{Binding Pattern}" Width="*"/>
                        <DataGridCheckBoxColumn Header="First Only" Binding="{Binding ExtractFirstOnly}" Width="80"/>
                        <DataGridTemplateColumn Width="60">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate x:CompileBindings="False">
                                    <Button Content="ðŸ—‘ï¸" Command="{Binding DataContext.RemoveRuleCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}" Background="Transparent" Foreground="Red"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
                <Button Content="+ Add Rule" Command="{Binding AddRuleCommand}" Margin="0,10,0,0"/>

                <Separator Margin="0,20"/>
                
                <TextBlock Text="AI / LLM Integration" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>
                <TextBlock Text="Configure Ollama (Local) or OpenAI (Cloud) for semantic analysis." Classes="label" Foreground="Gray" FontSize="12" Margin="0,0,0,10"/>
                
                <TextBlock Text="Provider" Classes="label"/>
                <ComboBox ItemsSource="{Binding LlmProviders}" SelectedItem="{Binding LlmProvider}" HorizontalAlignment="Stretch"/>
                
                <TextBlock Text="Model Name (e.g. phi3:mini, gpt-3.5-turbo)" Classes="label"/>
                <TextBox Text="{Binding LlmModelName}" Watermark="phi3:mini"/>
                
                <TextBlock Text="Base URL" Classes="label"/>
                <TextBox Text="{Binding LlmBaseUrl}" Watermark="http://localhost:11434"/>
                
                <!-- OLLAMA CONTROLS -->
                <StackPanel Margin="0,10" Orientation="Horizontal" Spacing="10" IsVisible="{Binding LlmProvider, Converter={x:Static ObjectConverters.Equal}, ConverterParameter={x:Static models:LlmProviderType.Ollama}}">
                    <Border CornerRadius="10" Width="10" Height="10" Background="{Binding IsOllamaRunning, Converter={x:Static ObjectConverters.IsNull}}"> <!-- Fallback visual check needed? No, use classes or simple status text color below -->
                        <!-- Actually simpler to just show text first -->
                    </Border>
                    
                    <TextBlock Text="{Binding OllamaStatus}" VerticalAlignment="Center" FontWeight="Bold"/>

                    <Button Content="Start Service" Command="{Binding StartOllamaCommand}" IsVisible="{Binding !IsOllamaRunning}"/>
                    <Button Content="Download Model" Command="{Binding PullModelCommand}" IsEnabled="{Binding !IsPullingModel}"/>
                </StackPanel>
                
                <TextBlock Text="API Key (Leave empty for Ollama)" Classes="label"/>
                <TextBox Text="{Binding LlmApiKey}" PasswordChar="*" Watermark="sk-..."/>

            </StackPanel>
        </ScrollViewer>

        <!-- Action Buttons -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,15,0,0">
            <Button Content="Cancel" Width="100" Click="OnCancelClick"/>
            <Button Content="Save" Width="100" Command="{Binding SaveSettingsCommand}" Click="OnSaveClick"
                    Background="#1392ec" Foreground="White"/>
        </StackPanel>
    </Grid>
</Window>
